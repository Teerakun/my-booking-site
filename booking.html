<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking | Photo Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #ff0032; --bg-glow: rgba(255, 0, 50, 0.15); --btn-text: #ffffff; }
        body { font-family: 'Kanit', sans-serif; background-color: #000; color: #fff; transition: background 0.5s ease; overflow-x: hidden; }
        .font-rog { font-family: 'Orbitron', sans-serif; }
        
        /* ‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î */
        .mode-change-anim { animation: mode-switch 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        @keyframes mode-switch {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(0.98); filter: brightness(1.5); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        input, select { background: rgba(255, 255, 255, 0.03) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; color: white !important; transition: all 0.3s; }
        input:focus, select:focus { border-color: var(--accent) !important; outline: none; box-shadow: 0 0 15px var(--bg-glow); }
        
        .rog-card { background: linear-gradient(145deg, #0a0a0a, #111); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.5s ease; border-top: 3px solid var(--accent); }
        .mode-btn { border: 1px solid rgba(255,255,255,0.1); color: #555; transition: 0.3s; cursor: pointer; }
        
        /* ‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÇ‡∏´‡∏°‡∏î */
        .btn-student.active { border-color: #ff0032; color: #fff; background: rgba(255,0,50,0.2); box-shadow: 0 0 15px rgba(255,0,50,0.3); }
        .btn-external.active { border-color: #ffffff; color: #000 !important; background: #ffffff; box-shadow: 0 0 15px rgba(255,255,255,0.3); }
        .btn-teacher.active { border-color: #a855f7; color: #fff; background: rgba(168,85,247,0.2); box-shadow: 0 0 15px rgba(168,85,247,0.3); }
        
        .main-button { background: var(--accent); color: var(--btn-text) !important; transition: all 0.3s; }
        .main-button:hover { filter: brightness(1.2); transform: translateY(-2px); box-shadow: 0 5px 20px var(--bg-glow); }

        .btn-loading { position: relative; color: transparent !important; pointer-events: none; }
        .btn-loading::after { content: ""; position: absolute; width: 20px; height: 20px; top: 50%; left: 50%; margin: -10px 0 0 -10px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        footer { font-size: 9px; letter-spacing: 2px; opacity: 0.5; text-align: center; margin-top: 40px; text-transform: uppercase; }
    </style>
</head>
<body class="min-h-screen pb-12">
    <nav class="p-6"><a href="index.html" class="text-gray-500 hover:text-white transition-colors font-rog text-[10px]">‚Üê BACK_TO_BASE</a></nav>

    <div class="max-w-md mx-auto px-6" id="main-container">
        <header class="mb-6 text-center">
            <h1 class="font-rog text-4xl font-bold italic tracking-tighter" id="title-text" style="color: var(--accent);">BOOKING</h1>
            <p id="mode_display" class="text-gray-500 text-[10px] tracking-[0.3em] uppercase mt-1">Terminal: Student_Internal</p>
        </header>

        <div class="flex gap-2 mb-8">
            <button type="button" onclick="setMode('student')" id="btn_student" class="mode-btn btn-student active flex-1 py-2 rounded-xl text-[9px] font-rog">STUDENT</button>
            <button type="button" onclick="setMode('external')" id="btn_external" class="mode-btn btn-external flex-1 py-2 rounded-xl text-[9px] font-rog">EXTERNAL</button>
            <button type="button" onclick="setMode('teacher')" id="btn_teacher" class="mode-btn btn-teacher flex-1 py-2 rounded-xl text-[9px] font-rog">TEACHER</button>
        </div>

        <form id="bookingForm" class="space-y-6">
            <div class="rog-card p-6 rounded-2xl space-y-4 shadow-2xl" id="form-card">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label id="label_id" class="block text-[10px] text-gray-500 uppercase mb-1 font-rog">Student ID</label>
                        <input type="text" id="main_id" required class="w-full p-3 rounded-xl text-sm" placeholder="6XXXX">
                    </div>
                    <div>
                        <label id="label_name" class="block text-[10px] text-gray-500 uppercase mb-1 font-rog">Nickname</label>
                        <input type="text" id="nickname" required class="w-full p-3 rounded-xl text-sm" placeholder="Name">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] text-gray-500 uppercase mb-1 font-rog">Photo Mode</label>
                        <select id="photo_mode" class="w-full p-3 rounded-xl text-sm">
                            <option value="Portrait">Portrait Photo</option>
                            <option value="Sport">Sport (+Extra Cost)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 uppercase mb-1 font-rog">Period</label>
                        <select id="time_period" class="w-full p-3 rounded-xl text-sm">
                            <option value="Daytime">Day (‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô)</option>
                            <option value="Nighttime">Night (+Extra Cost)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] text-gray-500 uppercase mb-1 font-rog">Access Password</label>
                    <input type="password" id="password" required class="w-full p-3 rounded-xl text-sm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <div>
                    <label class="block text-[10px] text-gray-500 uppercase mb-1 font-rog">Contact / Instagram</label>
                    <input type="text" id="ig" required class="w-full p-3 rounded-xl text-sm" placeholder="@username">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <input type="date" id="date" required class="w-full p-3 rounded-xl text-sm text-center">
                    <input type="time" id="time" required class="w-full p-3 rounded-xl text-sm text-center">
                </div>

                <div>
                    <input type="text" id="location" required class="w-full p-3 rounded-xl text-sm" placeholder="‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô? (‡∏ï‡∏∂‡∏Å/‡∏™‡∏ô‡∏≤‡∏°‡∏Å‡∏µ‡∏¨‡∏≤)">
                </div>

                <div class="space-y-2">
                    <label class="block text-[10px] text-gray-500 uppercase font-rog">Profile Image</label>
                    <input type="file" id="profile_img" accept="image/*" required onchange="previewImage(event)" class="text-[10px] text-gray-500 file:bg-white file:text-black file:border-0 file:rounded-full file:px-3 file:mr-3 cursor-pointer">
                    <div class="flex justify-center"><img id="imagePreview" src="#" class="hidden w-24 h-24 object-cover rounded-xl border-2 shadow-lg" style="border-color: var(--accent);"></div>
                </div>
            </div>

            <div class="rog-card p-5 rounded-2xl border-l-4 space-y-4" style="border-left-color: var(--accent);">
                <p class="text-[10px] font-rog tracking-widest uppercase opacity-80" style="color: var(--accent);">Data Consent & Agreement</p>
                <div class="space-y-3">
                    <label class="flex items-start cursor-pointer group">
                        <input type="checkbox" id="consent_ig" class="mt-1 mr-3 w-4 h-4 rounded accent-[#ff0032]"> 
                        <span class="text-[11px] text-gray-400 leading-relaxed group-hover:text-gray-200">
                            ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ô‡∏≥‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô <span class="text-white underline">Instagram Portfolio</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô
                        </span>
                    </label>
                    <label class="flex items-start cursor-pointer group">
                        <input type="checkbox" id="consent_com" class="mt-1 mr-3 w-4 h-4 rounded accent-[#ff0032]"> 
                        <span class="text-[11px] text-gray-400 leading-relaxed group-hover:text-gray-200">
                            ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô <span class="text-white underline">‡πÄ‡∏ä‡∏¥‡∏á‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</span> ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô
                        </span>
                    </label>
                </div>
            </div>

            <button type="submit" id="submitBtn" class="main-button w-full py-5 rounded-xl font-rog font-bold text-xs tracking-[0.4em] shadow-lg">
                CONFIRM_BOOKING
            </button>
        </form>

        <footer>
            ¬© 2026 PHOTOGRAPHY HUB // ENGINEERED FOR AESTHETICS<br>
            PRECISION ‚Ä¢ AESTHETICS ‚Ä¢ FUTURE
        </footer>
    </div>

    <script>
        const SUPABASE_URL = 'https://majmptlrmxncbaxpthql.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ham1wdGxybXhuY2JheHB0aHFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MzU4NzEsImV4cCI6MjA4NTQxMTg3MX0.aV9y2QQp0wTCH21L-M1a0h_bheM3iqogcIO1BfL59FM';
        const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1467049689487638713/Zw4gGahQwl07n37mqCzXFqRgNrWnC6Kpp9tpfzlSKtrFF_2yOgdvfjnkOVmnAlRsc8qD';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentMode = 'student';

        function setMode(mode) {
            currentMode = mode;
            const root = document.documentElement;
            const card = document.getElementById('form-card');
            
            card.classList.remove('mode-change-anim');
            void card.offsetWidth;
            card.classList.add('mode-change-anim');

            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn_' + mode).classList.add('active');

            if (mode === 'student') {
                root.style.setProperty('--accent', '#ff0032');
                root.style.setProperty('--bg-glow', 'rgba(255, 0, 50, 0.15)');
                root.style.setProperty('--btn-text', '#ffffff');
                updateLabels("Student ID", "Nickname", "6XXXX");
            } else if (mode === 'external') {
                root.style.setProperty('--accent', '#ffffff');
                root.style.setProperty('--bg-glow', 'rgba(255, 255, 255, 0.15)');
                root.style.setProperty('--btn-text', '#333333');
                updateLabels("Phone Number", "Nickname", "08XXXXXXXX");
            } else if (mode === 'teacher') {
                root.style.setProperty('--accent', '#a855f7');
                root.style.setProperty('--bg-glow', 'rgba(168, 85, 247, 0.15)');
                root.style.setProperty('--btn-text', '#ffffff');
                updateLabels("Phone Number", "Full Name", "08XXXXXXXX");
            }
            document.getElementById('mode_display').innerText = `Terminal: ${mode.toUpperCase()}_ACCESS`;
        }

        function updateLabels(idText, nameText, placeholder) {
            document.getElementById('label_id').innerText = idText;
            document.getElementById('label_name').innerText = nameText;
            document.getElementById('main_id').placeholder = placeholder;
        }

        function previewImage(e) {
            const reader = new FileReader();
            reader.onload = () => { 
                const p = document.getElementById('imagePreview'); 
                p.src = reader.result; 
                p.classList.remove('hidden'); 
            }
            reader.readAsDataURL(e.target.files[0]);
        }

        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.classList.add('btn-loading');

            const dataID = document.getElementById('main_id').value;
            const dataName = document.getElementById('nickname').value;
            const pMode = document.getElementById('photo_mode').value;
            const pPeriod = document.getElementById('time_period').value;

            let targetTable = (currentMode === 'student') ? 'bookings' : 
                              (currentMode === 'external') ? 'bookings_external' : 'bookings_teachers';

            try {
                const file = document.getElementById('profile_img').files[0];
                const fileName = `${currentMode}-${Date.now()}.jpg`;
                
                // 1. Upload Image
                const { error: uploadErr } = await _supabase.storage.from('profiles').upload(fileName, file);
                if (uploadErr) throw uploadErr;
                const { data: { publicUrl } } = _supabase.storage.from('profiles').getPublicUrl(fileName);

                // 2. Insert to Supabase
                const { error: dbErr } = await _supabase.from(targetTable).insert([{
                    student_id: dataID, nickname: dataName,
                    password: document.getElementById('password').value,
                    ig_account: document.getElementById('ig').value,
                    booking_date: document.getElementById('date').value,
                    booking_time: document.getElementById('time').value,
                    location: document.getElementById('location').value,
                    image_url: publicUrl,
                    consent_ig: document.getElementById('consent_ig').checked
                }]);
                if (dbErr) throw dbErr;

                // 3. Send to Discord (CRITICAL: Added await)
                const discordColor = (currentMode === 'student') ? 16711730 : (currentMode === 'external') ? 16777215 : 11032055;
                
                await fetch(DISCORD_WEBHOOK, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        embeds: [{ 
                            title: `üöÄ MISSION DISPATCHED: ${currentMode.toUpperCase()}`, 
                            color: discordColor,
                            fields: [
                                { name: "üë§ Client", value: dataName || "No Name", inline: true },
                                { name: "üÜî ID/Phone", value: dataID || "No ID", inline: true },
                                { name: "üì∏ Photo Mode", value: pMode === 'Sport' ? "Sport üî¥ (+Extra)" : "Portrait ‚ö™", inline: true },
                                { name: "‚è∞ Period", value: pPeriod === 'Nighttime' ? "Night üåë (+Extra)" : "Day ‚òÄÔ∏è", inline: true },
                                { name: "üìç Location", value: document.getElementById('location').value || "N/A" }
                            ], 
                            image: { url: publicUrl } 
                        }]
                    })
                });

                window.location.href = 'success.html';

            } catch (err) { 
                console.error(err);
                alert("Error: " + err.message); 
                btn.classList.remove('btn-loading'); 
            }
        });
    </script>
</body>
</html>

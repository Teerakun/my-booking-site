<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Booking | Photo Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #ff0032; --bg-glow: rgba(255, 0, 50, 0.15); --btn-text: #ffffff; }
        body { font-family: 'Kanit', sans-serif; background-color: #000; color: #fff; transition: background 0.4s ease; -webkit-tap-highlight-color: transparent; }
        .font-rog { font-family: 'Orbitron', sans-serif; }
        
        .mode-change-anim { animation: mode-switch 0.3s ease-out; }
        @keyframes mode-switch {
            0% { opacity: 0.8; transform: scale(0.99); }
            100% { opacity: 1; transform: scale(1); }
        }

        input, select { background: rgba(255, 255, 255, 0.05) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; color: white !important; appearance: none; }
        
        input[type="date"]:focus, input[type="time"]:focus {
            border-color: var(--accent) !important;
            box-shadow: none !important;
            outline: none;
        }
        
        .rog-card { background: linear-gradient(145deg, #0d0d0d, #121212); border: 1px solid rgba(255, 255, 255, 0.05); border-top: 3px solid var(--accent); }
        .mode-btn { border: 1px solid rgba(255,255,255,0.1); color: #777; transition: 0.3s; cursor: pointer; }
        
        .btn-student.active { border-color: #ff0032; color: #fff; background: rgba(255,0,50,0.2); }
        .btn-external.active { border-color: #ffffff; color: #000 !important; background: #ffffff; }
        .btn-teacher.active { border-color: #a855f7; color: #fff; background: rgba(168,85,247,0.2); }
        
        .main-button { background: var(--accent); color: var(--btn-text) !important; }
        .btn-loading::after { content: ""; position: absolute; width: 20px; height: 20px; top: 50%; left: 50%; margin: -10px 0 0 -10px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        footer { font-size: 8px; letter-spacing: 2px; opacity: 0.4; text-align: center; margin-top: 30px; }
    </style>
</head>
<body class="min-h-screen pb-12">
    <nav class="p-6"><a href="index.html" class="text-gray-500 hover:text-white transition-colors font-rog text-[10px]">‚Üê BACK_TO_BASE</a></nav>

    <div class="max-w-md mx-auto px-6">
        <header class="mb-6 text-center">
            <h1 class="font-rog text-4xl font-bold italic tracking-tighter" id="title-text" style="color: var(--accent);">BOOKING</h1>
            <p id="mode_display" class="text-gray-500 text-[10px] tracking-[0.3em] uppercase mt-1">Terminal: Student_Internal</p>
        </header>

        <div class="flex gap-2 mb-8">
            <button type="button" onclick="setMode('student')" id="btn_student" class="mode-btn btn-student active flex-1 py-2 rounded-xl text-[9px] font-rog">STUDENT</button>
            <button type="button" onclick="setMode('external')" id="btn_external" class="mode-btn btn-external flex-1 py-2 rounded-xl text-[9px] font-rog">EXTERNAL</button>
            <button type="button" onclick="setMode('teacher')" id="btn_teacher" class="mode-btn btn-teacher flex-1 py-2 rounded-xl text-[9px] font-rog">TEACHER</button>
        </div>

        <form id="bookingForm" class="space-y-6">
            <div class="rog-card p-6 rounded-2xl space-y-4 shadow-2xl" id="form-card">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label id="label_id" class="block text-[10px] text-gray-500 uppercase mb-1 font-rog">Student ID</label>
                        <input type="text" id="main_id" required class="w-full p-3 rounded-xl text-sm" placeholder="6XXXX">
                    </div>
                    <div>
                        <label id="label_name" class="block text-[10px] text-gray-500 uppercase mb-1 font-rog">Nickname</label>
                        <input type="text" id="nickname" required class="w-full p-3 rounded-xl text-sm" placeholder="Name">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] text-gray-500 uppercase mb-1 font-rog">Photo Mode</label>
                        <select id="photo_mode" class="w-full p-3 rounded-xl text-sm">
                            <option value="Portrait">Portrait Photo</option>
                            <option value="Sport">Sport (+Extra)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 uppercase mb-1 font-rog">Period</label>
                        <select id="time_period" class="w-full p-3 rounded-xl text-sm">
                            <option value="Daytime">Day (‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô)</option>
                            <option value="Nighttime">Night (+Extra)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] text-gray-500 uppercase mb-1 font-rog">Contact / IG</label>
                    <input type="text" id="ig" required class="w-full p-3 rounded-xl text-sm" placeholder="@username">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] text-gray-500 uppercase mb-1 font-rog">Date</label>
                        <input type="date" id="date" required class="w-full p-3 rounded-xl text-sm text-center">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 uppercase mb-1 font-rog">Time</label>
                        <input type="time" id="time" required class="w-full p-3 rounded-xl text-sm text-center">
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] text-gray-500 uppercase mb-1 font-rog">Location</label>
                    <input type="text" id="location" required class="w-full p-3 rounded-xl text-sm" placeholder="‡∏ï‡∏∂‡∏Å/‡∏™‡∏ô‡∏≤‡∏°‡∏Å‡∏µ‡∏¨‡∏≤">
                </div>

                <div class="space-y-2">
                    <label class="block text-[10px] text-gray-500 uppercase font-rog">Profile Image</label>
                    <input type="file" id="profile_img" accept="image/*" required onchange="previewImage(event)" class="text-[10px] text-gray-400">
                    <div class="flex justify-center"><img id="imagePreview" src="#" class="hidden w-24 h-24 object-cover rounded-xl border-2 shadow-lg" style="border-color: var(--accent);"></div>
                </div>
            </div>

            <button type="submit" id="submitBtn" class="main-button w-full py-5 rounded-xl font-rog font-bold text-xs tracking-[0.4em] shadow-lg">
                CONFIRM_BOOKING
            </button>
        </form>

        <footer>
            ¬© 2026 PHOTOGRAPHY HUB<br>ENGINEERED FOR AESTHETICS
        </footer>
    </div>

    <script>
        const SUPABASE_URL = 'https://majmptlrmxncbaxpthql.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ham1wdGxybXhuY2JheHB0aHFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MzU4NzEsImV4cCI6MjA4NTQxMTg3MX0.aV9y2QQp0wTCH21L-M1a0h_bheM3iqogcIO1BfL59FM';
        const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1467049689487638713/Zw4gGahQwl07n37mqCzXFqRgNrWnC6Kpp9tpfzlSKtrFF_2yOgdvfjnkOVmnAlRsc8qD';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentMode = 'student';

        function setMode(mode) {
            currentMode = mode;
            const root = document.documentElement;
            const card = document.getElementById('form-card');
            
            card.classList.remove('mode-change-anim');
            void card.offsetWidth;
            card.classList.add('mode-change-anim');

            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn_' + mode).classList.add('active');

            if (mode === 'student') {
                root.style.setProperty('--accent', '#ff0032');
                root.style.setProperty('--btn-text', '#ffffff');
                updateLabels("Student ID", "6XXXX");
            } else if (mode === 'external') {
                root.style.setProperty('--accent', '#ffffff');
                root.style.setProperty('--btn-text', '#333333');
                updateLabels("Phone Number", "08XXXXXXXX");
            } else if (mode === 'teacher') {
                root.style.setProperty('--accent', '#a855f7');
                root.style.setProperty('--btn-text', '#ffffff');
                updateLabels("Phone Number", "08XXXXXXXX");
            }
        }

        function updateLabels(idText, placeholder) {
            document.getElementById('label_id').innerText = idText;
            document.getElementById('main_id').placeholder = placeholder;
        }

        function previewImage(e) {
            const reader = new FileReader();
            reader.onload = () => { 
                const p = document.getElementById('imagePreview'); 
                p.src = reader.result; 
                p.classList.remove('hidden'); 
            }
            reader.readAsDataURL(e.target.files[0]);
        }

        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.classList.add('btn-loading');

            const dataID = document.getElementById('main_id').value;
            const dataName = document.getElementById('nickname').value;
            let targetTable = (currentMode === 'student') ? 'bookings' : (currentMode === 'external') ? 'bookings_external' : 'bookings_teachers';

            try {
                const file = document.getElementById('profile_img').files[0];
                const fileName = `${currentMode}-${Date.now()}.jpg`;
                const { error: uploadErr } = await _supabase.storage.from('profiles').upload(fileName, file);
                if (uploadErr) throw uploadErr;
                const { data: { publicUrl } } = _supabase.storage.from('profiles').getPublicUrl(fileName);

                await _supabase.from(targetTable).insert([{
                    student_id: dataID, nickname: dataName,
                    ig_account: document.getElementById('ig').value,
                    booking_date: document.getElementById('date').value,
                    booking_time: document.getElementById('time').value,
                    location: document.getElementById('location').value,
                    image_url: publicUrl
                }]);

                const discordColor = (currentMode === 'student') ? 16711730 : (currentMode === 'external') ? 16777215 : 11032055;
                
                await fetch(DISCORD_WEBHOOK, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        embeds: [{ 
                            title: `üöÄ NEW MISSION: ${currentMode.toUpperCase()}`, 
                            color: discordColor,
                            fields: [
                                { name: "üë§ Client", value: dataName, inline: true },
                                { name: "üÜî ID", value: dataID, inline: true },
                                { name: "üìç Location", value: document.getElementById('location').value }
                            ], 
                            image: { url: publicUrl } 
                        }]
                    })
                });

                window.location.href = 'success.html';
            } catch (err) { alert(err.message); btn.classList.remove('btn-loading'); }
        });
    </script>
</body>
</html>
